---
prometheus_node_dashboard: {
  "dashboard": {
    "title": "{{ ansible_date_time.epoch }}"
  , "rows": [
      { "panels": [
          { "title": "Idle cpu"
          , "type": "graph"
          , "datasource": "prometheus"
          , "renderer": "flot"
          , "span": 6
          , "xaxis": { "mode": "time" }
          , "yaxes": [{ "format": "percent"
                      , "label": "cpu usage"
                      , "show": true
                      , "max": 100
                      , "min": 0
                      },
                      { "format": "short" }]
          , "targets": [
              { "expr": "100 - (avg by (cpu) (irate(node_cpu{mode=\"idle\", instance=~\"$server\"}[5m])) * 100)"
              , "legendFormat": "{{ '{{cpu}}' }}"
              }]
          },
          { "title": "System load"
          , "type": "graph"
          , "datasource": "prometheus"
          , "renderer": "flot"
          , "span": 6
          , "targets": [
              { "expr": "node_load1{instance=~\"$server\"}"
              , "format": "time_series"
              , "legendFormat": "load 1m"
              },
              { "expr": "node_load5{instance=~\"$server\"}"
              , "format": "time_series"
              , "legendFormat": "load 5m"
              },
              { "expr": "node_load15{instance=~\"$server\"}"
              , "format": "time_series"
              , "legendFormat": "load 15m"
              }
            ]
          , "xaxis": { "mode": "time" }
          , "yaxes": [
              { "format": "short" }
            , { "format": "short" }]
          }
        ]
      },
      {
        "panels": [
          { "title": "Memory"
          , "type": "graph"
          , "datasource": "prometheus"
          , "renderer": "flot"
          , "span": 12
          , "xaxis": { "mode": "time" }
          , "yaxes": [ { "format": "bytes" }, { "format": "short" } ]
          , "seriesOverrides": [{ "alias": "node_memory_SwapFree{instance=\"172.17.0.1:9100\",job=\"prometheus\"}" , "yaxis": 2 }]
          , "targets": [
              { "expr": "node_memory_MemTotal{instance=~\"$server\"} - node_memory_MemAvailable{instance=~\"$server\"}"
              , "format": "time_series"
              , "legendFormat": "available"
              }]
          }]
      },{
        "panels": [
          { "title": "Disk usage"
          , "type": "graph"
          , "datasource": "prometheus"
          , "renderer": "flot"
          , "xaxis": { "mode": "time" }
          , "yaxes": [ { "format": "bytes" }, { "format": "ms" } ]
          , "seriesOverrides": [
              { "alias": "read", "yaxis": 1 }
            , { "alias": "{instance=\"172.17.0.1:9100\"}", "yaxis": 2 }
            , { "alias": "io time", "yaxis": 2 }]
          , "span": 10
          , "targets": [
              { "expr": "sum by (instance) (irate(node_disk_bytes_read{instance=~\"$server\"}[5m]))"
              , "format": "time_series"
              , "legendFormat": "read"
              },
              { "expr": "sum by (instance) (irate(node_disk_bytes_written{instance=~\"$server\"}[5m]))"
              , "format": "time_series"
              , "legendFormat": "written"
              },
              { "expr": "sum by (instance) (irate(node_disk_io_time_ms{instance=~\"$server\"}[5m]))"
              , "format": "time_series"
              , "legendFormat": "io time"
              }]
          },
          { "title": "Free disk space (lowest mountpoint)"
          , "type": "singlestat"
          , "datasource": "prometheus"
          , "format": "percentunit"
          , "thresholds": "0.10, 0.25"
          , "span": 2
          , "gauge": { "maxValue": 1
                     , "minValue": 0
                     , "show": true
                     , "thresholdLabels": false
                     , "thresholdMarkers": true
                     }
          , "targets": [{ "expr": "min(node_filesystem_free{instance=~\"$server\"} / node_filesystem_size{instance=~\"$server\"})"
                        , "format": "time_series"
                        , "step": 60
                        }]
          }
        ]
      },
      {
        "panels": [
          {
            "bars": false,
            "dashLength": 10,
            "dashes": false,
            "datasource": "prometheus",
            "fill": 1,
            "grid": {},
            "lines": true,
            "linewidth": 2,
            "links": [],
            "nullPointMode": "connected",
            "percentage": false,
            "pointradius": 5,
            "points": false,
            "renderer": "flot",
            "seriesOverrides": [
              {
                "alias": "transmitted ",
                "yaxis": 2
              }
            ],
            "spaceLength": 10,
            "span": 12,
            "stack": false,
            "steppedLine": false,
            "targets": [
              {
                "expr": "irate(node_network_receive_bytes{instance=~\"$server\",device!~\"lo\"}[5m])",
                "format": "time_series",
                "hide": false,
                "intervalFactor": 2,
                "legendFormat": "{{ '{{device}}' }} received",
                "refId": "A",
                "step": 4,
                "target": ""
              },
              {
                "expr": "irate(node_network_transmit_bytes{instance=~\"$server\",device!~\"lo\"}[5m])",
                "format": "time_series",
                "hide": false,
                "intervalFactor": 2,
                "legendFormat": "{{ '{{device}}' }} transmitted ",
                "refId": "B",
                "step": 4,
                "target": ""
              }
            ],
            "thresholds": [],
            "timeFrom": null,
            "timeShift": null,
            "title": "Data transfer",
            "tooltip": {
              "msResolution": false,
              "shared": true,
              "sort": 0,
              "value_type": "cumulative"
            },
            "type": "graph",
            "xaxis": {
              "buckets": null,
              "mode": "time",
              "name": null,
              "show": true,
              "values": []
            },
            "yaxes": [
              {
                "format": "Bps",
                "label": null,
                "logBase": 1,
                "max": null,
                "min": null,
                "show": true
              },
              {
                "format": "bytes",
                "label": null,
                "logBase": 1,
                "max": null,
                "min": null,
                "show": false
              }
            ]
          }
        ]
      }
    ],
    "templating": {
      "list": [
        {
          "current": {
            "text": "localhost:9100",
            "value": "localhost:9100"
          },
          "datasource": "prometheus",
          "name": "server",
          "query": "label_values(node_boot_time, instance)",
        }
      ]
    }
  }
}
